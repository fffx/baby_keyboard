name: App build
on: push


jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Switch xcode to latest-stable
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Install certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CERTIFICATE_BASE64_2026 }}
          CERTIFICATE_PASSPHRASE: ${{ secrets.CERTIFICATE_PASSPHRASE }}
        run: |
          # Check if secrets are set
          if [ -z "$CERTIFICATE_BASE64" ]; then
            echo "ERROR: CERTIFICATE_BASE64 secret is empty!"
            exit 1
          fi
          echo "Certificate base64 length: ${#CERTIFICATE_BASE64}"

          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Decode certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "Decoding certificate..."
          echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERT_PATH

          # Check file size
          CERT_SIZE=$(stat -f%z "$CERT_PATH" 2>/dev/null || stat -c%s "$CERT_PATH")
          echo "Certificate file size: $CERT_SIZE bytes"

          if [ "$CERT_SIZE" -lt 100 ]; then
            echo "ERROR: Certificate file is too small - likely invalid"
            exit 1
          fi

          # Verify it's a valid PKCS12 file
          echo "Verifying PKCS12 format..."
          if ! openssl pkcs12 -in $CERT_PATH -passin pass:"$CERTIFICATE_PASSPHRASE" -info -noout 2>&1; then
            echo "ERROR: Invalid PKCS12 file or wrong passphrase"
            exit 1
          fi

          # Show certificate details (expiry, subject, etc)
          echo ""
          echo "=== Certificate details ==="
          openssl pkcs12 -in $CERT_PATH -passin pass:"$CERTIFICATE_PASSPHRASE" -nokeys -clcerts | \
            openssl x509 -noout -subject -issuer -dates -serial 2>/dev/null || echo "Could not parse certificate"

          # Download and install Apple WWDR intermediate certificates
          echo "Installing Apple WWDR intermediate certificates..."
          curl -sL https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer -o $RUNNER_TEMP/AppleWWDRCAG3.cer
          curl -sL https://www.apple.com/certificateauthority/DeveloperIDG2CA.cer -o $RUNNER_TEMP/DeveloperIDG2CA.cer
          security import $RUNNER_TEMP/AppleWWDRCAG3.cer -k $KEYCHAIN_PATH -T /usr/bin/codesign
          security import $RUNNER_TEMP/DeveloperIDG2CA.cer -k $KEYCHAIN_PATH -T /usr/bin/codesign || true

          # Import certificate
          echo "Importing certificate..."
          security import $CERT_PATH \
            -P "$CERTIFICATE_PASSPHRASE" \
            -A \
            -t cert \
            -f pkcs12 \
            -k $KEYCHAIN_PATH

          # Allow codesign to access the keychain
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Add keychain to search list
          security list-keychain -d user -s $KEYCHAIN_PATH $(security list-keychains -d user | tr -d '"')

          # Verify import
          echo ""
          echo "=== Imported certificates ==="
          security find-identity -v -p codesigning $KEYCHAIN_PATH

          echo ""
          echo "=== All available codesigning identities ==="
          security find-identity -v -p codesigning

          # Cleanup
          rm -f $CERT_PATH
      - name: Run tests
        run: |
          xcodebuild test \
            -scheme BabyKeyboardLock \
            -destination 'platform=macOS' \
            | xcpretty && exit ${PIPESTATUS[0]}
      - name: Setup Ruby and fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.4.5
          bundler-cache: true
      - name: Install dependencies
        run: bundle install
      - name: Build and archive macOS app
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: bundle exec fastlane build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: build/BabyKeyboardLock-${{ github.ref_name }}.zip
  release:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: BabyKeyboardLock-${{ github.ref_name }}.zip
